name: "ctx1_gen2_dep8_batch64_eplb0_mtp2"

model:
  path: "dsr1"
  container: "dynamo-trtllm"
  precision: "fp4"

resources:
  gpu_type: "b200"
  prefill_nodes: 1
  prefill_workers: 1
  gpus_per_prefill: 4

  decode_workers: 2
  decode_nodes: 2

  gpus_per_node: 8

backend:
  type: trtllm

  prefill_environment:
    NCCL_GRAPH_MIXING_SUPPORT: "0"
    OMPI_MCA_coll_ucc_enable: "0"
    TLLM_ALL_RANK_LOG: "1"
    TLLM_LOG_LEVEL: "INFO"
    TRTLLM_ENABLE_PDL: "1"
    TRTLLM_SERVER_DISABLE_GC: "1"
    TRTLLM_WORKER_DISABLE_GC: "1"
    UCX_CUDA_IPC_ENABLE_MNNVL: "n"
    UCX_RNDV_SCHEME: "put_zcopy"

  decode_environment:
    NCCL_GRAPH_MIXING_SUPPORT: "0"
    OMPI_MCA_coll_ucc_enable: "0"
    TLLM_ALL_RANK_LOG: "1"
    TLLM_LOG_LEVEL: "INFO"
    TRTLLM_SERVER_DISABLE_GC: "1"
    TRTLLM_WORKER_DISABLE_GC: "1"
    UCX_CUDA_IPC_ENABLE_MNNVL: "n"
    UCX_RNDV_SCHEME: "put_zcopy"

  trtllm_config:
    prefill:
      max_batch_size: 8
      max_num_tokens: 10240
      max_seq_len: 1044
      tensor_parallel_size: 4
      moe_expert_parallel_size: 4
      enable_attention_dp: true
      pipeline_parallel_size: 1
      print_iter_log: true
      cuda_graph_config: null
      disable_overlap_scheduler: true
      moe_config:
        backend: TRTLLM
      kv_cache_config:
        enable_block_reuse: false
        free_gpu_memory_fraction: 0.75
        dtype: fp8
      cache_transceiver_config:
        max_tokens_in_buffer: 8448
        backend: UCX
      speculative_config:
        decoding_type: MTP
        num_nextn_predict_layers: 2

    decode:
      tensor_parallel_size: 8
      moe_expert_parallel_size: 8
      enable_attention_dp: true
      enable_lm_head_tp_in_adp: true
      pipeline_parallel_size: 1
      max_batch_size: 64
      max_num_tokens: 192
      max_seq_len: 2068
      cuda_graph_config:
        enable_padding: true
        batch_sizes:
        - 1
        - 2
        - 4
        - 8
        - 16
        - 32
        - 58
        - 60
        - 62
        - 64
      print_iter_log: true
      kv_cache_config:
        enable_block_reuse: false
        free_gpu_memory_fraction: 0.8
        dtype: fp8
      moe_config:
        backend: CUTLASS
        use_low_precision_moe_combine: true
      cache_transceiver_config:
        max_tokens_in_buffer: 8448
        backend: UCX
      stream_interval: 100
      num_postprocess_workers: 4
      speculative_config:
        decoding_type: MTP
        num_nextn_predict_layers: 2

benchmark:
  type: "sa-bench"
  isl: 1024
  osl: 1024
  concurrencies: "1214"
  req_rate: "inf"

frontend:
  nginx_container: "nginx-sqsh"
  type: "dynamo"

dynamo:
  install: false

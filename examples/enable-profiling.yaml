# GB200 FP8 Profiling Configuration
# Uses sglang.launch_server for torch profiling instead of dynamo.sglang
# This enables detailed performance profiling of prefill/decode operations

name: "gb200-fp8-profiling"

model:
  path: "/models/deepseek-r1"
  container: "/containers/sglang.sqsh"
  precision: "fp8"

resources:
  gpu_type: "gb200"
  prefill_nodes: 1
  decode_nodes: 1
  prefill_workers: 1
  decode_workers: 1
  gpus_per_node: 4

profiling:
  type: "torch"  # Options: "none", "torch", "nsys"
  # Traffic generator parameters (same for all phases)
  isl: 1024
  osl: 128
  concurrency: 1
  # Per-phase profiling step config
  prefill:
    start_step: 0
    stop_step: 50
  decode:
    start_step: 0
    stop_step: 50

backend:
  # Prefill-specific environment variables
  prefill_environment:
    TORCH_DISTRIBUTED_DEFAULT_TIMEOUT: "1800"
    PYTHONUNBUFFERED: "1"
    DYN_SKIP_SGLANG_LOG_FORMATTING: "1"
    SGLANG_DG_CACHE_DIR: "/configs/dg-10212025"
    SGLANG_ENABLE_JIT_DEEPGEMM: "false"
    SGLANG_ENABLE_FLASHINFER_GEMM: "1"
    SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE: "100000"
    SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT: "100000"
    SGLANG_DISAGGREGATION_WAITING_TIMEOUT: "100000"
    SGLANG_MOONCAKE_CUSTOM_MEM_POOL: "True"
    SGLANG_USE_MESSAGE_QUEUE_BROADCASTER: "0"
    SGLANG_DISABLE_TP_MEMORY_INBALANCE_CHECK: "1"
    MC_TE_METRIC: "true"
    MC_FORCE_MNNVL: "1"
    NCCL_MNNVL_ENABLE: "1"
    NCCL_CUMEM_ENABLE: "1"

  # Decode-specific environment variables
  decode_environment:
    TORCH_DISTRIBUTED_DEFAULT_TIMEOUT: "1800"
    PYTHONUNBUFFERED: "1"
    DYN_SKIP_SGLANG_LOG_FORMATTING: "1"
    SGLANG_DG_CACHE_DIR: "/configs/dg-10212025"
    SGLANG_ENABLE_JIT_DEEPGEMM: "false"
    SGLANG_ENABLE_FLASHINFER_GEMM: "1"
    SGLANG_DISAGGREGATION_HEARTBEAT_MAX_FAILURE: "100000"
    SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT: "100000"
    SGLANG_DISAGGREGATION_WAITING_TIMEOUT: "100000"
    SGLANG_DECODE_BOOTSTRAP_TIMEOUT: "1000"
    SGLANG_HACK_SEQ_BOOTSTRAP_ROOM: "1"
    SGLANG_MOONCAKE_CUSTOM_MEM_POOL: "True"
    SGLANG_USE_MESSAGE_QUEUE_BROADCASTER: "0"
    SGLANG_DISABLE_TP_MEMORY_INBALANCE_CHECK: "1"
    MC_TE_METRIC: "true"
    MC_FORCE_MNNVL: "1"
    NCCL_MNNVL_ENABLE: "1"
    NCCL_CUMEM_ENABLE: "1"

  sglang_config:
    prefill:
      # Model configuration
      served_model_name: "deepseek-ai/DeepSeek-R1"
      model_path: "/model/"
      trust_remote_code: true

      # KV cache and attention
      kv_cache_dtype: "fp8_e4m3"
      attention_backend: "trtllm_mla"

      # Quantization
      quantization: "fp8"
      moe_runner_backend: "flashinfer_trtllm"

      # Radix cache disabled
      disable_radix_cache: true

      # Other flags
      stream_interval: 10
      watchdog_timeout: 1000000
      context_length: 2200

      # Prefill-specific mode
      disaggregation_mode: "prefill"

      # Memory and token limits
      mem_fraction_static: 0.95
      max_total_tokens: 8192
      chunked_prefill_size: 8192
      cuda_graph_max_bs: 128

      # Request handling
      max_running_requests: 512
      load_balance_method: "round_robin"
      scheduler_recv_interval: 10

      # Performance optimizations
      enable_flashinfer_allreduce_fusion: true
      enable_symm_mem: true
      moe_dense_tp_size: 1

    decode:
      # Model configuration
      served_model_name: "deepseek-ai/DeepSeek-R1"
      model_path: "/model/"
      trust_remote_code: true

      # KV cache and attention
      kv_cache_dtype: "fp8_e4m3"
      attention_backend: "trtllm_mla"

      # Quantization
      quantization: "fp8"
      moe_runner_backend: "flashinfer_trtllm"

      # Radix cache disabled
      disable_radix_cache: true

      # Other flags
      stream_interval: 10
      watchdog_timeout: 1000000
      context_length: 2200

      # Decode-specific mode
      disaggregation_mode: "decode"

      # Memory and token limits
      mem_fraction_static: 0.95
      chunked_prefill_size: 8192
      cuda_graph_max_bs: 128

      # Request handling
      max_running_requests: 512
      scheduler_recv_interval: 10

      # Performance optimizations
      enable_flashinfer_allreduce_fusion: true
      enable_symm_mem: true
      moe_dense_tp_size: 1
      prefill_round_robin_balance: true

benchmark:
  type: "manual"  # Profiling runs without benchmarks

# Notes:
# - Profiling mode uses sglang.launch_server instead of dynamo.sglang
# - Profiling results saved to /logs/profiles/{mode}/ (prefill/decode/aggregated)
# - Each worker type gets profiled separately
# - See scripts/profiling/profile.sh for profiling implementation

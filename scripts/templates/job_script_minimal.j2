#!/bin/bash
#SBATCH --job-name={{ job_name }}
#SBATCH --nodes={{ total_nodes }}
#SBATCH --ntasks={{ total_nodes }}
#SBATCH --ntasks-per-node=1
{% if use_gpus_per_node_directive %}
#SBATCH --gpus-per-node={{ gpus_per_node }}
{% endif %}
{% if use_segment_sbatch_directive %}
#SBATCH --segment={{ total_nodes }}
{% endif %}
#SBATCH --account={{ account }}
#SBATCH --time={{ time_limit }}
#SBATCH --output=./outputs/%j/logs/sweep.log
#SBATCH --partition={{ partition }}
{% for key, value in sbatch_directives.items() %}
{% if value %}
#SBATCH --{{ key }}={{ value }}
{% else %}
#SBATCH --{{ key }}
{% endif %}
{% endfor %}

# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

# Orchestrator runs on HOST (needs srun access), spawns containerized workers
# Config: {{ config_path }}
# Generated: {{ timestamp }}

set -e

# Setup directories
WORK_DIR="${PWD}"
OUTPUT_DIR="${WORK_DIR}/outputs/${SLURM_JOB_ID}"
LOG_DIR="${OUTPUT_DIR}/logs"
mkdir -p "${LOG_DIR}"

# Redirect output
exec > >(tee "${LOG_DIR}/sweep_${SLURM_JOB_ID}.log")
exec 2>&1

echo "=========================================="
echo "ðŸš€ srtctl Sweep Orchestrator"
echo "=========================================="
echo "Job ID: ${SLURM_JOB_ID}"
echo "Config: {{ config_path }}"
echo "Nodes: ${SLURM_JOB_NUM_NODES}"
echo "Container: {{ container_image }}"
echo "Start: $(date)"
echo "=========================================="
echo ""

# Copy config to output directory
cp "{{ config_path }}" "${OUTPUT_DIR}/config.yaml"

# Get head node
HEAD_NODE=$(scontrol show hostnames ${SLURM_NODELIST} | head -n1)
echo "Head node: ${HEAD_NODE}"

# Install srtctl into a temporary location and add to PYTHONPATH
# This avoids needing srtctl pre-installed on the login node
SRTCTL_INSTALL_DIR="${OUTPUT_DIR}/.srtctl_install"
echo ""
echo "Installing srtctl to ${SRTCTL_INSTALL_DIR}..."
pip install --quiet --target="${SRTCTL_INSTALL_DIR}" "{{ srtctl_source }}"

export PYTHONPATH="${SRTCTL_INSTALL_DIR}:${PYTHONPATH}"

# Export source directory so orchestrator can find configs/ (NATS, etcd binaries)
export SRTCTL_SOURCE_DIR="{{ srtctl_source }}"

echo "Running orchestrator on host (with srun access)..."
echo ""

# Run orchestrator on the HOST (not in container) so it has access to srun
# The orchestrator will spawn containerized workers
python3 -u -m srtctl.cli.do_sweep "{{ config_path }}" 2>&1 | tee "${LOG_DIR}/orchestrator_${SLURM_JOB_ID}.log"

EXIT_CODE=${PIPESTATUS[0]}

echo ""
echo "=========================================="
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ“ Sweep completed successfully"
else
    echo "âœ— Sweep failed (exit code: $EXIT_CODE)"
fi
echo "End: $(date)"
echo "=========================================="

exit ${EXIT_CODE}
